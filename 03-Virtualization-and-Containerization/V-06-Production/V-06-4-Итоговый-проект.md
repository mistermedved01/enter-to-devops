[🏠 Главная](../../README.md) → [🐳 Virtualization-and-Containerization](../../README.md#-virtualization-and-containerization) → [🏭 V-06-Production](../../README.md#-v-06-production)

---

# 🐳V-06-4-Итоговый-проект
> Полноценное приложение с использованием всех изученных технологий: многосервисная архитектура, Docker Compose, сети, тома, мониторинг.

---

<details>
<summary><b>🎯 Описание проекта</b></summary>

---

### Full-stack приложение "Task Manager"

```text
# Архитектура проекта:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend API   │    │   Database      │
│   React SPA     │ →  │   Node.js       │ →  │   PostgreSQL    │
│   Nginx         │    │   Express       │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         ↑                       ↑                       ↑
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Load Balancer │    │   Cache         │    │   Monitoring    │
│   Nginx         │    │   Redis         │    │   Prometheus    │
│                 │    │                 │    │   Grafana       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Технологический стек

```text
🔹 Frontend: React + TypeScript + Vite
🔹 Backend: Node.js + Express + TypeScript  
🔹 Database: PostgreSQL + Redis
🔹 Web Server: Nginx
🔹 Monitoring: Prometheus + Grafana + cAdvisor
🔹 Orchestration: Docker Compose
🔹 Development: Hot-reload, debugging
```

**Цели проекта:**
- ✅ Практическое применение всех изученных технологий Docker
- ✅ Реализация production-ready архитектуры
- ✅ Настройка мониторинга и логирования
- ✅ Демонстрация best practices

---

</details>

<details>
<summary><b>🏗️ Структура проекта</b></summary>

---

### Файловая структура

```text
task-manager/
├── docker-compose.yml
├── docker-compose.prod.yml
├── .env.example
├── .dockerignore
├── nginx/
│   ├── nginx.conf
│   ├── Dockerfile
│   └── ssl/ (для production)
├── frontend/
│   ├── Dockerfile
│   ├── Dockerfile.dev
│   ├── src/
│   ├── package.json
│   └── vite.config.ts
├── backend/
│   ├── Dockerfile
│   ├── Dockerfile.dev
│   ├── src/
│   ├── package.json
│   └── tsconfig.json
├── monitoring/
│   ├── prometheus.yml
│   ├── grafana/
│   └── alerts.yml
└── scripts/
    ├── init-db.sh
    ├── backup.sh
    └── deploy.sh
```

### Docker Compose структура

```yaml
# docker-compose.yml
version: '3.8'

services:
  # База данных
  postgres:
    image: postgres:13-alpine
    environment:
      POSTGRES_DB: taskmanager
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    networks:
      - backend

  # Кэш
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - backend

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://appuser:${DB_PASSWORD}@postgres:5432/taskmanager
      REDIS_URL: redis://redis:6379
    volumes:
      - ./backend:/app
      - /app/node_modules
    ports:
      - "3001:3001"
    depends_on:
      - postgres
      - redis
    networks:
      - frontend
      - backend

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://localhost:3001
    depends_on:
      - backend
    networks:
      - frontend

  # Nginx (в development)
  nginx:
    build: ./nginx
    ports:
      - "80:80"
    depends_on:
      - frontend
      - backend
    networks:
      - frontend
      - backend

  # Мониторинг
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3002:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - monitoring

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - monitoring

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:

networks:
  frontend:
  backend:
  monitoring:
```

---

</details>

<details>
<summary><b>📦 Dockerfile для сервисов</b></summary>

---

### Backend Dockerfile

```dockerfile
# Backend/Dockerfile
FROM node:18-alpine as builder

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

FROM node:18-alpine

RUN addgroup -g 1001 -S app && \
    adduser -S app -u 1001

WORKDIR /app

COPY --from=builder --chown=app:app /app/node_modules ./node_modules
COPY --chown=app:app package*.json ./
COPY --chown=app:app dist ./dist

USER app

EXPOSE 3001

ENV NODE_ENV=production

CMD ["node", "dist/server.js"]
```

```dockerfile
# Backend/Dockerfile.dev
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3001

CMD ["npm", "run", "dev"]
```

### Frontend Dockerfile

```dockerfile
# Frontend/Dockerfile
FROM node:18-alpine as builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

```dockerfile
# Frontend/Dockerfile.dev
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000

CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

### Nginx Dockerfile

```dockerfile
# Nginx/Dockerfile
FROM nginx:alpine

COPY nginx.conf /etc/nginx/conf.d/default.conf
COPY ssl/ /etc/nginx/ssl/

EXPOSE 80 443
```

---

</details>

<details>
<summary><b>🔧 Конфигурационные файлы</b></summary>

---

### Nginx конфигурация

```nginx
# nginx/nginx.conf
upstream backend {
    server backend:3001;
}

upstream frontend {
    server frontend:3000;
}

server {
    listen 80;
    server_name localhost;

    # Frontend
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend API
    location /api {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Health checks
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

### Prometheus конфигурация

```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alerts.yml"

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']

  - job_name: 'backend'
    static_configs:
      - targets: ['backend:3001']
    metrics_path: '/metrics'

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

---

</details>

<details>
<summary><b>🚀 Запуск и управление</b></summary>

---

### Development режим

```bash
# Клонирование и настройка проекта
git clone <repository-url>
cd task-manager

# Копирование env файла
cp .env.example .env
# Редактирование .env с вашими значениями

# Запуск в development режиме
docker-compose up -d

# Просмотр логов
docker-compose logs -f backend

# Остановка
docker-compose down
```

### Production развертывание

```bash
# Production сборка
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

# Миграции базы данных
docker-compose exec backend npm run migrate

# Проверка здоровья
curl http://localhost/health

# Мониторинг
open http://localhost:3002 # Grafana
open http://localhost:9090 # Prometheus
```

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  nginx:
    ports:
      - "443:443"
    volumes:
      - ./nginx/ssl:/etc/nginx/ssl:ro

  node-exporter:
    image: prom/node-exporter:latest
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.ignored-mount-points'
      - '^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - monitoring
```

---

</details>

<details>
<summary><b>🔍 Мониторинг и логи</b></summary>

---

### Дашборды Grafana

```text
# Создаем дашборды для мониторинга:

1. 🏠 Общий обзор системы:
   • CPU и память всех контейнеров
   • Сетевая активность
   • Статус сервисов

2. 📊 Database мониторинг:
   • Количество подключений
   • Query performance
   • Размер базы данных

3. 🚀 Application метрики:
   • Response time API
   • Количество запросов
   • Error rate

4. 🔔 Alerting панель:
   • Активные алерты
   • История срабатываний
```

### Логирование

```bash
# Просмотр логов всех сервисов
docker-compose logs

# Логи конкретного сервиса
docker-compose logs -f backend

# Логи с фильтрацией ошибок
docker-compose logs backend | grep -i error

# Размер логов
docker system df
```

### Health checks

```bash
# Проверка здоровья сервисов
curl http://localhost/health
curl http://localhost:3001/health

# Проверка базы данных
docker-compose exec postgres pg_isready

# Проверка Redis
docker-compose exec redis redis-cli ping
```

---

</details>

<details>
<summary><b>🛠️ Утилиты и скрипты</b></summary>

---

### Скрипт инициализации БД

```bash
#!/bin/bash
# scripts/init-db.sh
set -e

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
    CREATE TABLE IF NOT EXISTS tasks (
        id SERIAL PRIMARY KEY,
        title VARCHAR(255) NOT NULL,
        description TEXT,
        status VARCHAR(50) DEFAULT 'pending',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX IF NOT EXISTS idx_tasks_status ON tasks(status);
    CREATE INDEX IF NOT EXISTS idx_tasks_created_at ON tasks(created_at);
EOSQL
```

### Скрипт бэкапа

```bash
#!/bin/bash
# scripts/backup.sh
set -e

BACKUP_DIR="./backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Бэкап PostgreSQL
docker-compose exec postgres pg_dump -U appuser taskmanager > $BACKUP_DIR/taskmanager_$TIMESTAMP.sql

# Бэкап Redis
docker-compose exec redis redis-cli SAVE
docker cp $(docker-compose ps -q redis):/data/dump.rdb $BACKUP_DIR/redis_$TIMESTAMP.rdb

echo "Backup completed: $BACKUP_DIR/taskmanager_$TIMESTAMP.sql"
echo "Backup completed: $BACKUP_DIR/redis_$TIMESTAMP.rdb"
```

### Скрипт деплоя

```bash
#!/bin/bash
# scripts/deploy.sh
set -e

echo "Starting deployment..."

# Pull latest changes
git pull origin main

# Build and start services
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build

# Run migrations
docker-compose exec backend npm run migrate

# Health check
sleep 10
curl -f http://localhost/health || exit 1

echo "Deployment completed successfully!"
```

---

</details>

<details>
<summary><b>🎯 Чеклист завершения</b></summary>

---

### Функциональность приложения

```text
✅ Frontend:
  • Создание задач
  • Просмотр списка задач
  • Фильтрация по статусу
  • Редактирование и удаление

✅ Backend API:
  • RESTful endpoints для задач
  • Валидация данных
  • Обработка ошибок
  • Кэширование с Redis

✅ Database:
  • Миграции
  • Индексы для производительности
  • Резервное копирование

✅ Infrastructure:
  • Load balancing
  • Мониторинг
  • Логирование
  • Health checks
```

### Docker features использованные

```text
✅ Multi-stage builds
✅ Docker Compose orchestration
✅ Custom networks
✅ Named volumes
✅ Environment variables
✅ Health checks
✅ Resource limits
✅ Logging configuration
✅ Port mapping
✅ Dependency management
```

### Production readiness

```text
✅ Безопасность: non-root users, read-only filesystems
✅ Надежность: health checks, restart policies
✅ Масштабируемость: stateless design, caching
✅ Мониторинг: metrics, logging, alerting
✅ Поддержка: backup scripts, documentation
✅ Производительность: resource limits, optimization
```

---

</details>

<details>
<summary><b>🚀 Дальнейшее развитие</b></summary>

---

### Улучшения и расширения

```text
🔹 Kubernetes миграция:
  • Deployment manifests
  • Service discovery
  • Auto-scaling

🔹 CI/CD пайплайн:
  • GitHub Actions
  • Automated testing
  • Deployment stages

🔹 Безопасность:
  • SSL/TLS сертификаты
  • API authentication
  • Rate limiting

🔹 База данных:
  • Репликация
  • Connection pooling
  • Advanced monitoring

🔹 Кэширование:
  • Redis cluster
  • Cache strategies
  • Performance optimization
```

### Что мы освоили

```text
🎓 Полный цикл разработки с Docker:
  • Локальная разработка с hot-reload
  • Production сборка и оптимизация
  • Оркестрация многоконтейнерных приложений
  • Мониторинг и диагностика
  • Безопасность и best practices

🚀 Готовность к реальным проектам:
  • Понимание production требований
  • Умение проектировать архитектуру
  • Навыки troubleshooting
  • Знание инструментов мониторинга
```

### Следующие шаги

```text
📚 Углубление в конкретные технологии:
  • Kubernetes для оркестрации
  • Service mesh (Istio, Linkerd)
  • Cloud providers (AWS, GCP, Azure)
  • Infrastructure as Code (Terraform)

🏢 Real-world практика:
  • Участие в open-source проектах
  • Создание собственных проектов
  • Изучение case studies компаний
```

---

</details>
