[🏠 Главная](../../README.md) → [🐳 Virtualization-and-Containerization](../../README.md#-virtualization-and-containerization) → [🏭 V-06-Production](../../README.md#-v-06-production)

---

# 🐳V-06-2-Мониторинг-и-логи
> Мониторинг и логи Docker: сбор метрик, анализ логов, трейсинг, алертинг и визуализация состояния контейнеров и кластеров.

---

<details>
<summary><b>🎯 Архитектура мониторинга Docker</b></summary>

---

### Компоненты системы мониторинга

```text
# Полный стек мониторинга Docker
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Сбор метрик   │    │  Хранение данных│    │  Визуализация   │
│                 │    │                 │    │                 │
│ • cAdvisor      │ →  │ • Prometheus    │ →  │ • Grafana       │
│ • Node Exporter │    │ • Elasticsearch │    │ • Kibana        │
│ • Docker Stats  │    │ • InfluxDB      │    │ • Docker Dashboard│
└─────────────────┘    └─────────────────┘    └─────────────────┘
         ↓                       ↓                       ↓
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Сбор логов    │    │  Анализ логов   │    │   Алертинг      │
│                 │    │                 │    │                 │
│ • Log Drivers   │ →  │ • ELK Stack     │ →  │ • Alertmanager  │
│ • Fluentd       │    │ • Loki          │    │ • PagerDuty     │
│ • Filebeat      │    │ • Graylog       │    │ • OpsGenie      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Ключевые метрики для мониторинга

```text
📊 Контейнеры:
• CPU использование (%) 
• Память usage/limit (MB)
• Network I/O (bytes/sec)
• Disk I/O (ops/sec)
• Restart count

🏗️ Хост система:
• Load average
• Disk usage (%)
• Memory usage
• Network traffic
• Running processes

🌐 Кластер (Swarm):
• Node status
• Service replicas
• Task states  
• Network health
```

---

</details>

<details>
<summary><b>📊 Сбор метрик</b></summary>

---

### Встроенные инструменты Docker

```bash
# Статистика контейнеров в реальном времени
docker stats

# Статистика с форматированием
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"

# Статистика всех контейнеров (включая остановленные)
docker stats --all

# Просмотр использования диска
docker system df
docker system df -v

# События Docker
docker system events --filter type=container
```

### cAdvisor - сборщик метрик от Google

```bash
# Запуск cAdvisor
docker run -d \
  --name=cadvisor \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:ro \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  --volume=/dev/disk/:/dev/disk:ro \
  --publish=8080:8080 \
  --detach=true \
  gcr.io/cadvisor/cadvisor:latest

# Доступ к UI: http://localhost:8080
```

### Node Exporter для метрик хоста

```bash
# Запуск Node Exporter
docker run -d \
  --name=node-exporter \
  --net="host" \
  --pid="host" \
  --volume="/:/host:ro,rslave" \
  quay.io/prometheus/node-exporter:latest \
  --path.rootfs=/host

# Метрики доступны на http://localhost:9100/metrics
```

### Prometheus для сбора и хранения

```yaml
# docker-compose.yml для Prometheus
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'

volumes:
  prometheus_data:
```

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'docker'
    static_configs:
      - targets: ['cadvisor:8080']
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
```

---

</details>

<details>
<summary><b>📝 Управление логами</b></summary>

---

### Docker Log Drivers

```bash
# Просмотр текущего log driver
docker info --format '{{.LoggingDriver}}'

# Запуск контейнера с конкретным log driver
docker run -d \
  --log-driver=json-file \
  --log-opt max-size=10m \
  --log-opt max-file=3 \
  nginx:alpine

# Syslog driver
docker run -d \
  --log-driver=syslog \
  --log-opt syslog-address=udp://loghost:514 \
  nginx:alpine

# Journald driver
docker run -d \
  --log-driver=journald \
  nginx:alpine
```

### Просмотр и фильтрация логов

```bash
# Просмотр логов контейнера
docker logs my-container

# Логи в реальном времени
docker logs -f my-container

# Последние N строк
docker logs --tail 100 my-container

# Логи с временными метками
docker logs -t my-container

# Логи за определенный период
docker logs --since 2024-01-01T00:00:00 my-container

# Фильтрация по строке
docker logs my-container | grep "ERROR"
```

### Centralized Logging с ELK Stack

```yaml
# docker-compose.yml для ELK
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.5.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"

  logstash:
    image: docker.elastic.co/logstash/logstash:8.5.0
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    ports:
      - "5000:5000"
    depends_on:
      - elasticsearch

  kibana:
    image: docker.elastic.co/kibana/kibana:8.5.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

volumes:
  es_data:
```

---

</details>

<details>
<summary><b>📈 Визуализация метрик</b></summary>

---

### Grafana для дашбордов

```yaml
# docker-compose.yml для Grafana
version: '3.8'

services:
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./dashboards:/etc/grafana/provisioning/dashboards
    depends_on:
      - prometheus

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus

volumes:
  grafana_data:
  prometheus_data:
```

### Полезные дашборды Grafana

```text
📊 Docker Host Metrics:
• CPU usage per container
• Memory usage and limits  
• Network I/O throughput
• Disk I/O operations
• Container restarts

🏗️ Swarm Cluster:
• Node status and resource usage
• Service replication status
• Task failures and restarts
• Network overlay health
• Volume usage

🚨 Alerting Dashboard:
• Active alerts
• Alert history
• Service health status
• Resource thresholds
```

### Docker Desktop Dashboard

```text
# Встроенный мониторинг в Docker Desktop
• Real-time container metrics
• Resource usage graphs
• Log viewer with search
• Volume and network usage
• Easy access to container actions
```

---

</details>

<details>
<summary><b>🚨 Алертинг и оповещения</b></summary>

---

### Alertmanager для Prometheus

```yaml
# docker-compose.yml для Alertmanager
version: '3.8'

services:
  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    depends_on:
      - prometheus
```

```yaml
# alertmanager.yml
global:
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@example.com'
  smtp_auth_username: 'user'
  smtp_auth_password: 'password'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://127.0.0.1:5001/'
```

### Правила алертинга для Prometheus

```yaml
# alerts.yml
groups:
  - name: docker.alerts
    rules:
      - alert: HighMemoryUsage
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.8
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          description: "Container {{ $labels.container }} is using {{ $value }}% of its memory limit"

      - alert: ContainerRestarted
        expr: increase(container_last_seen{name=~".+"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Container restarted"
          description: "Container {{ $labels.name }} has restarted"
```

### Health checks в Docker

```yaml
# docker-compose.yml с health checks
version: '3.8'

services:
  web:
    image: nginx:alpine
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  api:
    image: node:16
    healthcheck:
      test: ["CMD", "node", "healthcheck.js"]
      interval: 30s
      timeout: 5s
      retries: 5
```

---

</details>

<details>
<summary><b>🔍 Анализ и трассировка</b></summary>

---

### Distributed Tracing с Jaeger

```yaml
# docker-compose.yml для Jaeger
version: '3.8'

services:
  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "14268:14268"
    environment:
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411

  app:
    image: my-app:latest
    environment:
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
```

### Логирование структурированных логов

```json
// Структурированный лог в JSON формате
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "ERROR",
  "service": "api-gateway",
  "container_id": "abc123",
  "message": "Failed to connect to database",
  "error": "Connection timeout",
  "duration_ms": 5000,
  "user_id": "user-123",
  "request_id": "req-456"
}
```

### Анализ производительности

```bash
# Профилирование CPU контейнера
docker exec my-container perf record -g -p 1

# Анализ использования памяти
docker exec my-container cat /sys/fs/cgroup/memory/memory.stat

# Сетевые метрики
docker exec my-container cat /sys/class/net/eth0/statistics/rx_bytes

# I/O статистика
docker exec my-container iostat -x 1
```

---

</details>

<details>
<summary><b>🏗️ Production-ready настройки</b></summary>

---

### Мониторинг Swarm кластера

```yaml
# docker-stack.yml для мониторинга Swarm
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - prometheus_data:/prometheus
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    deploy:
      placement:
        constraints:
          - node.role == manager

  node-exporter:
    image: prom/node-exporter:latest
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.ignored-mount-points'
      - '^/(sys|proc|dev|host|etc)($$|/)'
    deploy:
      mode: global

configs:
  prometheus_config:
    file: ./prometheus.yml
```

### Логирование в production

```yaml
# Production log configuration
version: '3.8'

services:
  app:
    image: my-app:latest
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "production"
        env: "os,customer"

  nginx:
    image: nginx:alpine
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://logstash:5000"
        tag: "nginx"
```

### Ротация и архивация логов

```bash
# Настройка logrotate для Docker
sudo cat > /etc/logrotate.d/docker << EOF
/var/lib/docker/containers/*/*.log {
  rotate 7
  daily
  compress
  delaycompress
  missingok
  copytruncate
}
EOF

# Мониторинг размера логов
du -sh /var/lib/docker/containers/*/*.log | sort -hr
```

---

</details>

<details>
<summary><b>🔧 Инструменты и утилиты</b></summary>

---

### ctop - топ для контейнеров

```bash
# Установка ctop
curl -fsSL https://azlux.fr/repo.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/azlux-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/azlux-archive-keyring.gpg] http://packages.azlux.fr/debian stable main" | sudo tee /etc/apt/sources.list.d/azlux.list
sudo apt update && sudo apt install docker-ctop

# Использование
ctop
```

### DockStation - GUI мониторинг

```text
# Возможности DockStation:
• Визуальное управление контейнерами
• Real-time мониторинг ресурсов
• Просмотр логов с фильтрацией
• Анализ использования томов и сетей
• Управление Docker Compose проектами
```

### Loki для логов

```yaml
# docker-compose.yml для Loki
version: '3.8'

services:
  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml

  promtail:
    image: grafana/promtail:latest
    volumes:
      - /var/log:/var/log
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
```

---

</details>

<details>
<summary><b>🎯 Ключевые выводы</b></summary>

---

### Best Practices мониторинга

```text
✅ Мониторьте на всех уровнях: контейнеры, хост, кластер
✅ Используйте структурированные логи для легкого анализа
✅ Настройте алертинг на критические метрики
✅ Храните логи и метрики отдельно от приложения
✅ Регулярно проверяйте и обновляйте дашборды
✅ Тестируйте систему алертинга
✅ Настройте retention политики для логов и метрик
```

### Критические метрики для алертинга

```text
🚨 High CPU usage (>80% продолжительное время)
🚨 High memory usage (>90% от limit)
🚨 Частые рестарты контейнеров
🚨 Network connectivity issues
🚨 Disk space running out
🚨 Service replica count mismatch
🚨 Node not ready в кластере
```

### Полный стек для production

```text
📊 Метрики: Prometheus + Node Exporter + cAdvisor
📈 Визуализация: Grafana с Docker дашбордами
📝 Логи: Loki или ELK Stack
🚨 Алертинг: Alertmanager с интеграциями
🔍 Трассировка: Jaeger для distributed tracing
🛠️ Утилиты: ctop, dockerd events, docker stats
```

---

</details>
