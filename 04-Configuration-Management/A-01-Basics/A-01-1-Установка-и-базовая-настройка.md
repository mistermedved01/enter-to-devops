[🏠 Главная](../../README.md) → [⚙️ Configuration-Management](../../README.md#-configuration-management) → [🚀 A-01-Basics](../../README.md#-a-01-basics)

---

# ⚙️A-01-1-Установка-и-базовая-настройка
> Установка Ansible на различные ОС, настройка окружения, конфигурационные файлы и первое подключение к управляемым узлам.

---

<details>
<summary><b>🎯 Требования к системе</b></summary>

---

### Control Node требования

+++text
# Control Node - хост с установленным Ansible
┌─────────────────────────────────┐
│        Control Node             │
│   (Ansible Management Host)     │
├─────────────────────────────────┤
│  ✅ Linux (Ubuntu, CentOS, etc.)│
│  ✅ macOS 10.10+                │
│  ✅ Windows (WSL2 recommended)  │
│  ✅ Python 3.8+                 │
│  ✅ SSH client                  │
└─────────────────────────────────┘
---text

### Managed Nodes требования

+++text
# Managed Nodes - целевые серверы
┌─────────────────────────────────┐
│        Managed Nodes            │
│    (Target Servers)             │
├─────────────────────────────────┤
│  ✅ Linux/Unix система          │
│  ✅ Python 2.7+ или 3.5+        │
│  ✅ SSH доступ                  │
│  ✅ sudo права (для многих задач)│
└─────────────────────────────────┘

# Поддерживаемые ОС:
• Red Hat Enterprise Linux 6+
• CentOS 6+
• Ubuntu 12.04+
• Debian 7+
• Fedora
• macOS
• BSD варианты
---text

### Сетевые требования

+++text
# Сетевая конфигурация
Control Node должен иметь доступ к Managed Nodes:
• SSH порт (обычно 22)
• Возможность аутентификации по ключам
• Разрешенный sudo для пользователя
• Доступ к репозиториям пакетов (если нужно)

# Рекомендуемая архитектура:
┌─────────────┐    SSH    ┌─────────────┐
│  Control    │ ────────→ │   Managed   │
│   Node      │           │    Node 1   │
│             │    SSH    └─────────────┘
│             │ ────────→ ┌─────────────┐
│             │           │   Managed   │
└─────────────┘           │    Node 2   │
                          └─────────────┘
---text

---

</details>

<details>
<summary><b>📦 Установка Ansible</b></summary>

---

### Установка на Ubuntu/Debian

+++bash
# Обновление системы
sudo apt update && sudo apt upgrade -y

# Установка Python и зависимостей
sudo apt install -y python3 python3-pip sshpass

# Установка Ansible через apt
sudo apt install -y ansible

# Проверка установки
ansible --version

# Альтернатива: установка через pip
sudo pip3 install ansible
---bash

### Установка на CentOS/RHEL

+++bash
# Установка EPEL репозитория (CentOS/RHEL 7/8)
sudo yum install -y epel-release

# Установка Ansible
sudo yum install -y ansible

# Для CentOS/RHEL 8+
sudo dnf install -y ansible

# Проверка установки
ansible --version
---bash

### Установка на macOS

+++bash
# Установка через Homebrew
brew install ansible

# Или через pip
pip3 install ansible

# Проверка установки
ansible --version
---bash

### Установка на Windows

+++bash
# Через WSL2 (рекомендуется)
# 1. Установить WSL2 с Ubuntu
# 2. В WSL выполнить:
sudo apt update && sudo apt install -y ansible

# Через Chocolatey (менее предпочтительно)
choco install ansible
---bash

### Установка через pip (универсальный способ)

+++bash
# Установка pip если нет
sudo apt install -y python3-pip  # Ubuntu/Debian
sudo yum install -y python3-pip  # CentOS/RHEL

# Установка Ansible
sudo pip3 install ansible

# Проверка
ansible --version
---bash

---

</details>

<details>
<summary><b>🔧 Базовая настройка</b></summary>

---

### Структура каталогов Ansible

+++text
# Рекомендуемая структура проекта
ansible-project/
├── ansible.cfg          # Конфигурация Ansible
├── inventory            # Файл инвентаря
│   ├── hosts           # Основной инвентарь
│   └── group_vars/     # Переменные групп
│       └── all.yml     # Глобальные переменные
├── playbooks/          # Playbook файлы
│   └── site.yml        # Основной playbook
├── roles/              # Роли Ansible
└── files/              # Статические файлы
---text

### Создание базовой конфигурации

+++bash
# Создание рабочего каталога
mkdir ~/ansible-project
cd ~/ansible-project

# Создание ansible.cfg
cat > ansible.cfg << EOF
[defaults]
inventory = ./inventory/hosts
host_key_checking = False
remote_user = ubuntu
private_key_file = ~/.ssh/id_rsa

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False
EOF
---bash

### Настройка SSH доступа

+++bash
# Генерация SSH ключа если нет
ssh-keygen -t rsa -b 4096 -C "ansible-control-node"

# Копирование ключа на управляемые узлы
ssh-copy-id ubuntu@managed-node-ip

# Тестирование подключения
ssh ubuntu@managed-node-ip
---bash

---

</details>

<details>
<summary><b>📋 Создание инвентаря</b></summary>

---

### Базовый inventory файл

+++text
# inventory/hosts
[web_servers]
web1.example.com
web2.example.com ansible_host=192.168.1.11
web3.example.com ansible_host=192.168.1.12 ansible_user=deploy

[db_servers]
db1.example.com ansible_host=192.168.1.21
db2.example.com ansible_host=192.168.1.22

[production:children]
web_servers
db_servers

[production:vars]
ansible_ssh_private_key_file=~/.ssh/production_key
timezone=Europe/Moscow
---text

### Переменные в инвентаре

+++text
# Определение переменных на разных уровнях:

1. Глобальные переменные (group_vars/all.yml):
   package_manager: apt
   system_user: deploy

2. Переменные групп (group_vars/web_servers.yml):
   web_package: nginx
   web_port: 80

3. Переменные хостов (в inventory):
   host1 ansible_host=192.168.1.10 http_port=8080

4. Host variables (host_vars/host1.yml):
   database_host: localhost
   cache_enabled: true
---text

### Создание структуры каталогов

+++bash
# Создание полной структуры
mkdir -p ~/ansible-project/{inventory,playbooks,roles,files,group_vars,host_vars}

# Создание основных файлов
touch ~/ansible-project/inventory/hosts
touch ~/ansible-project/playbooks/site.yml

# Создание group_vars
mkdir -p ~/ansible-project/group_vars
cat > ~/ansible-project/group_vars/all.yml << EOF
---
ansible_ssh_private_key_file: "~/.ssh/id_rsa"
ansible_user: "ubuntu"
timezone: "Europe/Moscow"
EOF
---bash

---

</details>

<details>
<summary><b>🚀 Первое подключение</b></summary>

---

### Тестирование подключения

+++bash
# Проверка синтаксиса inventory
ansible-inventory -i inventory/hosts --list

# Ping всех хостов в inventory
ansible all -i inventory/hosts -m ping

# Ping конкретной группы
ansible web_servers -i inventory/hosts -m ping

# Проверка с выводом фактов
ansible all -i inventory/hosts -m setup | less
---bash

### Ad-Hoc команды для проверки

+++bash
# Проверка доступности
ansible all -i inventory/hosts -m ping

# Проверка свободной памяти
ansible all -i inventory/hosts -a "free -h"

# Проверка дискового пространства
ansible all -i inventory/hosts -a "df -h"

# Проверка версии ОС
ansible all -i inventory/hosts -a "cat /etc/os-release"
---bash

### Устранение проблем с подключением

+++bash
# Проверка SSH подключения
ssh -i ~/.ssh/id_rsa ubuntu@web1.example.com

# Проверка с verbose выводом
ansible all -i inventory/hosts -m ping -vvv

# Проверка конкретного хоста
ansible web1.example.com -i inventory/hosts -m ping -vvv

# Проверка Python на managed node
ansible all -i inventory/hosts -a "python3 --version"
---bash

---

</details>

<details>
<summary><b>⚙️ Конфигурация ansible.cfg</b></summary>

---

### Основные настройки

+++text
# ansible.cfg - основные секции
[defaults]
inventory      = ./inventory/hosts    # Путь к инвентарю
host_key_checking = False            # Отключение проверки host key
remote_user    = ubuntu              # Пользователь по умолчанию
private_key_file = ~/.ssh/id_rsa     # SSH ключ по умолчанию
roles_path    = ./roles              # Путь к ролям

[privilege_escalation]
become          = True               # Включение sudo
become_method   = sudo               # Метод повышения прав
become_user     = root               # Пользователь для become
become_ask_pass = False              # Не запрашивать пароль

[ssh_connection]
ssh_args        = -o ControlMaster=auto -o ControlPersist=60s
pipelining      = True               # Ускорение выполнения
---text

### Оптимизация производительности

+++text
# Настройки для ускорения работы
[defaults]
forks = 10                           # Количество параллельных процессов
gathering = smart                    # Умный сбор фактов
fact_caching = memory                # Кэширование фактов
stdout_callback = yaml               # Формат вывода
bin_ansible_callbacks = True         # Callbacks для производительности

[ssh_connection]
control_path = %(directory)s/%%h-%%r  # SSH control path
pipelining = True                    # pipelining для ускорения
---text

### Приоритет конфигурационных файлов

+++text
# Ansible ищет конфиг в следующем порядке:
1. ANSIBLE_CONFIG (переменная окружения)
2. ./ansible.cfg (текущая директория)
3. ~/.ansible.cfg (домашняя директория)
4. /etc/ansible/ansible.cfg (глобальная конфигурация)

# Рекомендуется:
• Использовать ./ansible.cfg для проектов
• Хранить конфиг в системе контроля версий
• Не использовать глобальный /etc/ansible/ansible.cfg
---text

---

</details>

<details>
<summary><b>🔍 Проверка установки</b></summary>

---

### Комprehensive проверка

+++bash
# Проверка версии Ansible
ansible --version

# Проверка инвентаря
ansible-inventory --list

# Проверка подключения ко всем хостам
ansible all -m ping

# Проверка фактов
ansible all -m setup -a "filter=ansible_distribution*"

# Проверка доступных модулей
ansible-doc -l | head -20
---bash

### Создание тестового playbook

+++yaml
# playbooks/test.yml
---
- name: Test Ansible Installation
  hosts: all
  become: yes
  
  tasks:
    - name: Display OS information
      debug:
        msg: "This is {{ ansible_distribution }} {{ ansible_distribution_version }}"
    
    - name: Check disk space
      command: df -h
      register: disk_result
    
    - name: Display disk space
      debug:
        var: disk_result.stdout
---yaml

+++bash
# Запуск тестового playbook
ansible-playbook playbooks/test.yml

# Запуск с проверкой синтаксиса
ansible-playbook --syntax-check playbooks/test.yml

# Запуск в режиме проверки (dry-run)
ansible-playbook --check playbooks/test.yml
---bash

---

</details>

<details>
<summary><b>🎯 Ключевые выводы</b></summary>

---

### Что мы сделали

+++text
✅ Установили Ansible на Control Node
✅ Настроили SSH доступ к Managed Nodes
✅ Создали структуру проекта Ansible
✅ Настроили inventory и конфигурационные файлы
✅ Протестировали подключение к управляемым узлам
✅ Запустили первый playbook
---text

### Best Practices установки

+++text
🔧 Используйте отдельного пользователя для Ansible
🔑 Настройте SSH доступ по ключам
📁 Создавайте структурированные проекты
⚙️ Настраивайте ansible.cfg для каждого проекта
🔍 Всегда проверяйте подключение перед работой
📚 Документируйте структуру инвентаря
---text

### Что изучаем дальше

+++text
📚 Следующая тема: Ansible архитектура и инвентарь
🎯 Углубление: Группы, переменные, динамический инвентарь
🔧 Практика: Создание сложных inventory структур
---text

---

</details>
