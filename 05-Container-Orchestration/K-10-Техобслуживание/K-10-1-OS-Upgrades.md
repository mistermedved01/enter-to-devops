[🏠 Главная](../../README.md) → [☸️ Container-Orchestration](../../README.md#-container-orchestration) → [🔧 K-10-Техобслуживание](../../README.md#-k-10-техобслуживание)

---

# 🔧K-10-1-OS-Upgrades
>Обслуживание узлов кластера: отключение узлов для обновления ОС, команды drain, uncordon и cordon, управление рабочими нагрузками при обслуживании

---

<details>
<summary><b>📋Введение в обслуживание узлов</b></summary>

---

В процессе эксплуатации кластера Kubernetes возникает необходимость в обслуживании узлов. Это может включать:

- Обновление базового программного обеспечения
- Применение патчей безопасности
- Обновление операционной системы
- Замена оборудования
- Плановое техническое обслуживание

Для выполнения таких задач требуется временно отключить узел от кластера, не нарушая работу приложений.

---

</details>

<details>
<summary><b>⚡Поведение кластера при отказе узла</b></summary>

---

## Сценарий отключения узла

Рассмотрим кластер с несколькими узлами и работающими на них Pod:

```
┌─────────────────────────────────────────────────────┐
│  Кластер Kubernetes                                  │
│                                                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  Node 1  │  │  Node 2  │  │  Node 3  │          │
│  │          │  │          │  │          │          │
│  │ 🟢 Pod   │  │ 🟢 Pod   │  │ 🔴 Pod   │          │
│  │ 🟢 Pod   │  │ 🔴 Pod   │  │          │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└─────────────────────────────────────────────────────┘
```

При отказе одного из узлов поведение приложений зависит от их конфигурации:

### Приложения с несколькими репликами

Если приложение развернуто с несколькими репликами (например, зеленые Pod), пользователи не пострадают, так как запросы будут обрабатываться другими репликами, оставшимися в рабочем состоянии.

### Приложения с одной репликой

Если приложение имеет только одну реплику (например, розовый Pod), пользователи пострадают, так как единственный экземпляр приложения был запущен на недоступном узле.

---

</details>

<details>
<summary><b>⏱️Pod Eviction Timeout</b></summary>

---

## Механизм восстановления

Kubernetes имеет встроенный механизм обработки отказов узлов:

### Если узел быстро вернулся

Если узел вернулся в рабочее состояние в течение короткого времени, процесс `kubelet` запускается и приводит все Pod в надлежащее состояние, Pod снова становятся доступными.

### Если узел не работает более 5 минут

Если узел не работает более 5 минут, Pod на этом узле считаются недоступными. Kubernetes помечает их как мертвые.

Если недоступный Pod является частью ReplicaSet, он будет автоматически воссоздан на других узлах кластера.

## Параметр pod-eviction-timeout

Время ожидания возврата Pod в оперативный режим называется `pod-eviction-timeout` и устанавливается в `kube-controller-manager` с дефолтным значением **5 минут**.

```
┌─────────────────────────────────────────────────────┐
│  Узел отключен                                       │
│                                                       │
│  ┌─────────────────────────────────────────────┐   │
│  │  < 5 минут: ожидание восстановления         │   │
│  │  > 5 минут: Pod помечаются как мертвые     │   │
│  │  → ReplicaSet создает новые Pod на других   │   │
│  │     узлах                                    │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

### Поведение после возврата узла

Когда узел возвращается в строй после истечения `pod-eviction-timeout`, он становится пустым, и на него не запланированы никакие Pod. Существующие Pod остаются на узлах, куда они были перенесены.

---

</details>

<details>
<summary><b>🔄Команда kubectl drain</b></summary>

---

## Безопасное отключение узла

Для планового обслуживания, когда время выполнения работ неизвестно или превышает 5 минут, используется более безопасный подход — команда `kubectl drain`.

### Принцип работы

Команда `kubectl drain` выполняет следующие действия:

1. **Graceful termination** — аккуратное завершение всех Pod на узле
2. **Перемещение Pod** — Pod воссоздаются на других узлах кластера
3. **Блокировка узла** — узел помечается как `unschedulable` (не подлежащий планированию)

### Синтаксис

```bash
kubectl drain <node-name>
```

### Пример использования

```bash
# Отключить узел node01 и переместить все Pod
kubectl drain node01
```

### Что происходит при drain

```
┌─────────────────────────────────────────────────────┐
│  До drain:                                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  Node 1  │  │  Node 2  │  │  Node 3  │          │
│  │          │  │          │  │          │          │
│  │ 🟢 Pod   │  │ 🟢 Pod   │  │ 🔴 Pod   │          │
│  │ 🔴 Pod   │  │          │  │          │          │
│  └──────────┘  └──────────┘  └──────────┘          │
│                                                       │
│  kubectl drain node01                                │
│                                                       │
│  После drain:                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  Node 1  │  │  Node 2  │  │  Node 3  │          │
│  │ (drained)│  │          │  │          │          │
│  │          │  │ 🟢 Pod   │  │ 🔴 Pod   │          │
│  │          │  │ 🟢 Pod   │  │ 🔴 Pod   │          │
│  │          │  │ 🔴 Pod   │  │          │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└─────────────────────────────────────────────────────┘
```

> **⚠️ Важно:** После выполнения `drain` узел помечается как `unschedulable`, и на него нельзя назначать новые Pod до тех пор, пока не будет снято это ограничение.

---

</details>

<details>
<summary><b>✅Команда kubectl uncordon</b></summary>

---

## Возврат узла в кластер

После завершения обслуживания узел необходимо вернуть в кластер. Для этого используется команда `kubectl uncordon`.

### Синтаксис

```bash
kubectl uncordon <node-name>
```

### Пример использования

```bash
# Вернуть узел node01 в кластер
kubectl uncordon node01
```

### Что происходит при uncordon

Команда `uncordon` снимает метку `unschedulable` с узла, после чего scheduler снова начинает назначать Pod на этот узел.

### Поведение существующих Pod

> **📌 Важно:** Pod, которые были перенесены на другие узлы во время `drain`, **не возвращаются автоматически** на исходный узел. Они продолжают работать на узлах, куда были перемещены.

Новые Pod или Pod, которые будут пересозданы (например, при обновлении Deployment), могут быть запланированы на освободившийся узел.

---

</details>

<details>
<summary><b>🚫Команда kubectl cordon</b></summary>

---

## Блокировка узла без перемещения Pod

Команда `kubectl cordon` используется для блокировки узла без перемещения существующих Pod.

### Отличие от drain

| Команда | Завершает Pod | Перемещает Pod | Блокирует планирование |
|---------|---------------|----------------|------------------------|
| `cordon` | ❌ Нет | ❌ Нет | ✅ Да |
| `drain` | ✅ Да | ✅ Да | ✅ Да |

### Синтаксис

```bash
kubectl cordon <node-name>
```

### Пример использования

```bash
# Заблокировать узел node01 без перемещения Pod
kubectl cordon node01
```

### Когда использовать cordon

Команда `cordon` полезна, когда нужно:

- Предотвратить назначение новых Pod на узел
- Сохранить существующие Pod на узле
- Выполнить обслуживание без перемещения рабочих нагрузок

### Схема работы

```
┌─────────────────────────────────────────────────────┐
│  До cordon:                                          │
│  ┌──────────┐  ┌──────────┐                        │
│  │  Node 1  │  │  Node 2  │                        │
│  │          │  │          │                        │
│  │ 🟢 Pod   │  │ 🟢 Pod   │                        │
│  │ 🔴 Pod   │  │          │                        │
│  └──────────┘  └──────────┘                        │
│                                                       │
│  kubectl cordon node01                               │
│                                                       │
│  После cordon:                                        │
│  ┌──────────┐  ┌──────────┐                        │
│  │  Node 1  │  │  Node 2  │                        │
│  │ (cordoned)│  │          │                        │
│  │ 🟢 Pod   │  │ 🟢 Pod   │                        │
│  │ 🔴 Pod   │  │          │                        │
│  │ (остались)│  │          │                        │
│  └──────────┘  └──────────┘                        │
│  Новые Pod не назначаются                             │
└─────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>📝Практический пример: обновление ОС узла</b></summary>

---

## Сценарий

Необходимо обновить операционную систему на узле `node01` без прерывания работы приложений.

## Шаги выполнения

### 1. Проверка текущего состояния

```bash
# Проверить статус узлов
kubectl get nodes

# Проверить Pod на узле node01
kubectl get pods -o wide --field-selector spec.nodeName=node01
```

### 2. Отключение узла и перемещение Pod

```bash
# Выполнить drain для безопасного отключения узла
kubectl drain node01 --ignore-daemonsets --delete-emptydir-data
```

**Параметры:**
- `--ignore-daemonsets` — игнорировать DaemonSet Pod (они не могут быть перемещены)
- `--delete-emptydir-data` — удалить данные из emptyDir volumes

### 3. Выполнение обслуживания

После выполнения `drain` можно безопасно:

```bash
# Обновить ОС (пример для Ubuntu/Debian)
ssh node01
sudo apt update && sudo apt upgrade -y
sudo reboot
```

### 4. Возврат узла в кластер

После перезагрузки и проверки работоспособности:

```bash
# Вернуть узел в кластер
kubectl uncordon node01

# Проверить статус
kubectl get nodes
```

### 5. Проверка распределения Pod

```bash
# Убедиться, что новые Pod могут назначаться на узел
kubectl get pods -o wide
```

---

</details>

<details>
<summary><b>⚙️Дополнительные параметры kubectl drain</b></summary>

---

## Полезные флаги

### --ignore-daemonsets

DaemonSet Pod не могут быть перемещены, так как они должны работать на каждом узле. Используйте этот флаг для игнорирования DaemonSet:

```bash
kubectl drain node01 --ignore-daemonsets
```

### --delete-emptydir-data

Удаляет данные из emptyDir volumes при перемещении Pod:

```bash
kubectl drain node01 --delete-emptydir-data
```

### --force

Принудительное выполнение drain даже если есть Pod, которые не могут быть перемещены:

```bash
kubectl drain node01 --force
```

### --grace-period

Время ожидания graceful shutdown Pod (в секундах):

```bash
kubectl drain node01 --grace-period=300
```

### --timeout

Общее время ожидания выполнения команды:

```bash
kubectl drain node01 --timeout=600s
```

---

</details>

<details>
<summary><b>🔍Проверка статуса узла</b></summary>

---

## Команды для проверки

### Просмотр статуса узлов

```bash
# Список всех узлов с их статусами
kubectl get nodes

# Детальная информация об узле
kubectl describe node node01
```

### Проверка метки unschedulable

Узел с меткой `unschedulable` имеет статус `SchedulingDisabled`:

```bash
# Вывод покажет SchedulingDisabled для заблокированных узлов
kubectl get nodes

# Пример вывода:
# NAME      STATUS                     ROLES    AGE   VERSION
# node01    Ready,SchedulingDisabled   <none>   10d   v1.28.0
# node02    Ready                      <none>   10d   v1.28.0
```

### Просмотр Pod на узле

```bash
# Все Pod на конкретном узле
kubectl get pods -o wide --field-selector spec.nodeName=node01

# Pod с учетом всех namespaces
kubectl get pods -A -o wide --field-selector spec.nodeName=node01
```

---

</details>

---

## Связанные темы

- **[K-10-1-OS-Upgrades](K-10-1-OS-Upgrades.md)** — обновление ОС узлов **← Текущая тема**
- **[K-10-2-K8s-Software-Versions](K-10-2-K8s-Software-Versions.md)** — версионирование Kubernetes
- **[K-10-3-Cluster-Upgrade-Process](K-10-3-Cluster-Upgrade-Process.md)** — процесс обновления кластера
- **[K-10-4-Backup-and-Restore-Methods](K-10-4-Backup-and-Restore-Methods.md)** — методы резервного копирования и восстановления

---

## Что дальше?

В следующей теме [K-10-2-K8s-Software-Versions](K-10-2-K8s-Software-Versions.md) мы рассмотрим структуру версий Kubernetes, типы релизов (stable, beta, alpha) и управление версиями компонентов кластера.

---