[🏠 Главная](../../README.md) → [☸️ Container-Orchestration](../../README.md#-container-orchestration) → [🔄 K-09-Жизненный-цикл-приложений](../../README.md#-k-09-жизненный-цикл-приложений)

---

# 🔄K-09-9-Self-Healing-Apps
>Самовосстановление в Kubernetes: уровни самовосстановления (приложение, компоненты, инфраструктура), ReplicaSets, probes, multi-cloud и hybrid-cloud развертывания

---

<details>
<summary><b>🔄Введение: самовосстановление в Kubernetes</b></summary>

---

## О чем эта лекция

Привет и добро пожаловать. Это необязательная лекция для курса CKA, тут будет много общих рассуждений.

Можно нескромно сказать, что Kubernetes является королем самовосстановления. Он позволяет запускать приложения надежным, высокодоступным и стабильным способом в нескольких инфраструктурах.

Фактически, Kubernetes имеет уникальные возможности для выполнения этого обещания. Но тот факт, что у него есть возможность, не означает, что они доступны по умолчанию.

И еще говорят, что свита делает короля. Поэтому и Kubernetes не может обойтись без помощников.

---

## Три уровня самовосстановления

Когда говорят о самовосстановлении, обычно имеют в виду уровень приложения, но, далее мы увидим, этого недостаточно.

```
┌─────────────────────────────────────────────────────────┐
│  Уровень 3: Инфраструктура                               │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Виртуальные машины, диски, сети                  │   │
│  │  Облачные инструменты (Auto Scaling Groups)       │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Уровень 2: Компоненты Kubernetes                 │   │
│  │  kubelet, kube-proxy, container runtime           │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Уровень 1: Приложение                            │   │
│  │  ReplicaSets, Probes, Pod Conditions              │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>📱Уровень 1: Самовосстановление приложений</b></summary>

---

## ReplicaSets для автоматического восстановления

Итак первый уровень - уровень приложения. Kubernetes обеспечивает самовосстановлением через ReplicaSets.

Контроллер репликации помогает обеспечить автоматическое воссоздание PODs при сбое приложения в POD. Это помогает обеспечить постоянную работу достаточного количества реплик приложения.

### Схема работы ReplicaSet

```
┌─────────────────────────────────────────────────────────┐
│  ReplicaSet: app-rs                                      │
│  Desired: 3 replicas                                     │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                   │   │
│  │  POD 1: Running ✅                                │   │
│  │  POD 2: Running ✅                                │   │
│  │  POD 3: Running ✅                                │   │
│  │                                                   │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼ (POD 2 падает)
┌─────────────────────────────────────────────────────────┐
│  ReplicaSet обнаруживает сбой                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  POD 1: Running ✅                                │   │
│  │  POD 2: Failed ❌                                 │   │
│  │  POD 3: Running ✅                                │   │
│  │                                                   │   │
│  │  Current: 2/3 (не соответствует desired)          │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼ (автоматическое восстановление)
┌─────────────────────────────────────────────────────────┐
│  ReplicaSet создает новый POD                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  POD 1: Running ✅                                │   │
│  │  POD 2: Failed ❌ (удаляется)                     │   │
│  │  POD 3: Running ✅                                │   │
│  │  POD 4: Running ✅ (новый)                        │   │
│  │                                                   │   │
│  │  Current: 3/3 ✅                                  │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Зависимость от качества приложения

Тем не менее здесь ОЧЕНЬ многое зависит от разработчика приложения и насколько хорошо контейниризировано приложение.

Как мы можем повлиять на самовосстановление с этого уровня, кроме деплоя качественных образов?

---

## Kubernetes Probes

Kubernetes предоставляет дополнительную поддержку для проверки работоспособности приложений, работающих в POD, и принятия необходимых действий с помощью внутренних проверок- `probes`.

Мы не будем погружаться в их настройку, они не требуются для экзамена CKA. Это темы для экзамена Certified Kubernetes Application Developers (CKAD), которые и будут там рассматриваются.

### Типы Probes

- **Liveness Probe** - проверяет, жив ли контейнер
- **Readiness Probe** - проверяет, готов ли контейнер принимать трафик
- **Startup Probe** - проверяет, запустилось ли приложение

---

## Pod Phase и Pod Conditions

Для анализа ситуации на уровне приложений нам также помогают механизмы Pod phase и Pod conditions.

### Pod Phases

- **Pending** - POD создан, но контейнеры еще не запущены
- **Running** - POD привязан к узлу, все контейнеры запущены
- **Succeeded** - все контейнеры завершились успешно
- **Failed** - хотя бы один контейнер завершился с ошибкой
- **Unknown** - состояние POD не может быть определено

---

## Container Restart Policy

А для ремедиации проблем в какой-то мере может помочь настройка Container restart policy.

### Restart Policies

- **Always** - контейнер всегда перезапускается (по умолчанию)
- **OnFailure** - контейнер перезапускается только при ошибке
- **Never** - контейнер никогда не перезапускается

---

</details>

<details>
<summary><b>⚙️Уровень 2: Самовосстановление компонентов</b></summary>

---

## Компоненты Kubernetes на узле

Теперь поднимемся выше на уровень компонентов. На каждом узле работает ряд компонентов Kubernetes, необходимых для поддержания работоспособности Kubernetes.

Сюда входят kubelet, kube-proxy и среды выполнения контейнеров.

### Схема компонентов на узле

```
┌─────────────────────────────────────────────────────────┐
│  Node: worker-1                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                   │   │
│  │  kubelet                                          │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Управляет PODs на узле                     │ │   │
│  │  │  Отслеживает состояние контейнеров          │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  │                                                   │   │
│  │  kube-proxy                                       │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Управляет сетевыми правилами                │ │   │
│  │  │  Обеспечивает доступность Services          │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  │                                                   │   │
│  │  Container Runtime (containerd/Docker)           │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Запускает и управляет контейнерами          │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  │                                                   │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Проблема сбоя компонентов

Если один из этих компонентов выходит из строя, узел может перестать отвечать.

Хотя Kubernetes примет к сведению, здесь могут пройти минуты, прежде чем он это сделает. В это время мы можем столкнуться с перебоями в обслуживании.

### Схема сбоя компонента

```
┌─────────────────────────────────────────────────────────┐
│  Нормальная работа                                       │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Node: worker-1                                   │   │
│  │  kubelet: ✅ Running                              │   │
│  │  kube-proxy: ✅ Running                           │   │
│  │  Container Runtime: ✅ Running                    │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼ (kubelet падает)
┌─────────────────────────────────────────────────────────┐
│  Сбой компонента                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Node: worker-1                                   │   │
│  │  kubelet: ❌ Failed                                │   │
│  │  kube-proxy: ✅ Running (но не может работать)   │   │
│  │  Container Runtime: ✅ Running                    │   │
│  │                                                   │   │
│  │  ⚠️ Узел не отвечает                              │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼ (через несколько минут)
┌─────────────────────────────────────────────────────────┐
│  Kubernetes обнаруживает проблему                       │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Node: worker-1 (NotReady)                        │   │
│  │  PODs переносятся на другие узлы                   │   │
│  │  ⚠️ Но это может занять 5+ минут                  │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Недостаточность простого отката

Правильного отката с помощью таких инструментов, как Terraform или kops, недостаточно.

Нам нужен компонент, который постоянно будет отслеживать состояние всех компонентов Kubernetes, а также решение обеспечивающее быстрое восстановление с минимальным влиянием на остальную часть кластера.

---

</details>

<details>
<summary><b>🏗️Уровень 3: Самовосстановление инфраструктуры</b></summary>

---

## Проблема сбоя инфраструктуры

Ок, переместимся еще на ступеньку выше и охватим взглядом нашу инфраструктуру.

В любой момент виртуальная машина или диск могут выйти из строя. Хотя Kubernetes переназначит PODs наших приложений, как только обнаружит, что узел больше не доступен (что может занять 5 минут), он не сможет самостоятельно развернуть новый узел.

Все, что он может сделать, - это перетасовать ресурсы в рамках существующей инфраструктуры. Если свободных мощностей не хватит, не повезло.

### Схема сбоя инфраструктуры

```
┌─────────────────────────────────────────────────────────┐
│  Нормальная работа                                       │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Node 1: ✅ Running                               │   │
│  │  Node 2: ✅ Running                               │   │
│  │  Node 3: ✅ Running                               │   │
│  │                                                   │   │
│  │  PODs распределены по узлам                       │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼ (VM падает)
┌─────────────────────────────────────────────────────────┐
│  Сбой инфраструктуры                                     │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Node 1: ✅ Running                               │   │
│  │  Node 2: ❌ Failed (VM недоступна)                │   │
│  │  Node 3: ✅ Running                               │   │
│  │                                                   │   │
│  │  ⚠️ PODs на Node 2 недоступны                     │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼ (через 5 минут)
┌─────────────────────────────────────────────────────────┐
│  Kubernetes обнаруживает сбой                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Node 1: ✅ Running                               │   │
│  │  Node 2: ❌ NotReady                              │   │
│  │  Node 3: ✅ Running                               │   │
│  │                                                   │   │
│  │  PODs переносятся на Node 1 и Node 3              │   │
│  │  ⚠️ Если ресурсов не хватает - проблемы!         │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼ (Kubernetes НЕ может создать новый узел)
┌─────────────────────────────────────────────────────────┐
│  Проблема: нет автоматического восстановления узла       │
│  ┌──────────────────────────────────────────────────┐   │
│  │  ❌ Kubernetes не может создать новый узел       │   │
│  │  ❌ Нужен внешний механизм                        │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Решения для самовосстановления инфраструктуры

Чтобы предоставить новую инфраструктуру, когда это необходимо, тебе понадобится внешний механизм, обеспечивающий самовосстановление нод.

### Облачные решения

При использовании облака можно использовать облачные инструменты для мониторинга виртуальных машин и автоматического перезапуска или запуска новой в случае отсутствия healthchecks c узла.

#### Azure

- **Scale Sets** - автоматическое масштабирование и восстановление VM

#### AWS

- **Auto Scaling Groups** - автоматическое управление EC2 инстансами

#### GCP

- **Instance Groups** - автоматическое управление VM инстансами

### Схема работы облачного самовосстановления

```
┌─────────────────────────────────────────────────────────┐
│  Облачный провайдер (AWS/GCP/Azure)                     │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                   │   │
│  │  Auto Scaling Group / Scale Set                  │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Мониторинг health checks узлов              │ │   │
│  │  │  Обнаружение сбоя узла                       │ │   │
│  │  │  Автоматическое создание нового узла         │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  │                                                   │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Kubernetes Cluster                              │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Node 1: ✅                                 │ │   │
│  │  │  Node 2: ❌ (заменяется)                    │ │   │
│  │  │  Node 3: ✅                                 │ │   │
│  │  │  Node 4: ✅ (новый)                         │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### Локальные решения

Локально с VMware или на baremetal нам понадобится еще какая-то внешняя система, для упреждающего мониторинга инфраструктуры и принятия мер для ремедиации, когда это необходимо.

Например, с VMware система может подготовить новый виртуальный узел, если старый больше не отвечает и т. д.

---

</details>

<details>
<summary><b>🌐Multi-Cloud и Hybrid-Cloud развертывания</b></summary>

---

## Проблема надежности инфраструктуры

Как мы видели, Kubernetes обеспечивает самовосстановление приложений в PODs, и если один POD выходит из строя, Kubernetes перезапускает новый.

Однако, если вся нода падает, Kubernetes обычно не может запустить новую.

Получается, что с перспективы самовосстановления инфраструктура может превратиться в самое слабое звено в цепочке, ставя под угрозу надежность наших приложений.

Это потому, что надежность наших кластеров зависит от базовой инфраструктуры. И это означает, что даже лучшее решение для управления Kubernetes не может защитить нас от плохой подготовки инфраструктуры.

---

## Managed Kubernetes в облаке

При использовании managed Kubernetes из облака тебе не нужно беспокоиться о надежности и самовосстановлении - облако заботится об этом за нас.

### Преимущества Managed Kubernetes

- Автоматическое обновление и патчинг
- Встроенный мониторинг и логирование
- Автоматическое масштабирование узлов
- Высокая доступность из коробки

---

## Вызовы Multi-Cloud и Hybrid-Cloud

Но поскольку Multi-Cloud или Hybrid-Cloud развертывания становятся все более распространенными, надежность становится уже твоей ответственностью, даже если ты используешь разного рода фреймворки и инструменты вроде Terraform.

### Схема Multi-Cloud развертывания

```
┌─────────────────────────────────────────────────────────┐
│  Multi-Cloud Kubernetes                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │                                                   │   │
│  │  AWS EKS                                          │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Свой подход к управлению                   │ │   │
│  │  │  Свой мониторинг                             │ │   │
│  │  │  Свои таймауты                              │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  │                                                   │   │
│  │  GCP GKE                                          │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Другой подход к управлению                 │ │   │
│  │  │  Другой мониторинг                           │ │   │
│  │  │  Другие таймауты                             │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  │                                                   │   │
│  │  Azure AKS                                        │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Третий подход к управлению                  │ │   │
│  │  │  Третий мониторинг                            │ │   │
│  │  │  Третьи таймауты                             │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  │                                                   │   │
│  │  ⚠️ Нужны разные инструменты для каждого          │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Проблемы совместимости

Также развертывание в нескольких облаках с управляемым Kubernetes не всегда возможно из-за несовместимости управляемых кластеров разных клауд-вендоров.

### Основные проблемы

1. **Разные подходы к управлению** - Managed Kubernetes разных облачных провайдеров обладает разным подходом к управлению
2. **Разные системы мониторинга** - у каждого свой мониторинг, поэтому придется использовать разные инструменты, чтобы привести их в соответствие со своей системой управления
3. **Разный перфоманс и задержки** - в разных облаках и их регионах разный перфоманс и задержки
4. **Разные таймауты** - у вендоров могут различаются стандартные таймауты в кластере
5. **Разные версии** - если твои приложения используют передовые фичи Kubernetes, вендоры внедряют новые версии с задержкой
6. **Разные container runtimes** - у разных провайдеров разный набор движков выполнения контейнеров, тебе нужно знать об этом, при планировании своих развертываний
7. **Ресурсные квоты** - ресурсные квоты от облаков - их нужно знать и иметь в виду, как в обычной облачной стратегии, так и в мульти-клауд

---

## Решения для Multi-Cloud

На самом деле не все так страшно, но в любом случае тебе нужно будет знать, как работает аварийное восстановление и как реализована надежность в каждой из твоих мульти-сред и подобрать подходящие для этого инструменты.

### Рекомендации

- Использовать единые инструменты управления (Terraform, Ansible)
- Внедрить единую систему мониторинга (Prometheus, Grafana)
- Стандартизировать конфигурации кластеров
- Документировать различия между облаками
- Планировать с учетом ограничений каждого облака

---

</details>

---

## Резюме

### Три уровня самовосстановления

1. **Уровень приложения**
   - ReplicaSets автоматически воссоздают упавшие PODs
   - Probes проверяют работоспособность приложений
   - Pod Phase и Pod Conditions для анализа состояния
   - Container Restart Policy для управления перезапусками

2. **Уровень компонентов**
   - kubelet, kube-proxy, container runtime на каждом узле
   - Сбой компонента может привести к недоступности узла
   - Kubernetes обнаруживает проблему через несколько минут
   - Нужны внешние системы для мониторинга компонентов

3. **Уровень инфраструктуры**
   - Виртуальные машины и диски могут выйти из строя
   - Kubernetes не может самостоятельно создать новый узел
   - Нужны облачные инструменты (Auto Scaling Groups, Scale Sets)
   - Локально нужны внешние системы мониторинга

### Ключевые выводы

- **Kubernetes обеспечивает самовосстановление на уровне приложений**, но не на уровне инфраструктуры
- **Инфраструктура может быть самым слабым звеном** в цепочке самовосстановления
- **Managed Kubernetes** упрощает управление, но в multi-cloud становится сложнее
- **Высокодоступные приложения** требуют самовосстановления на всех трех уровнях
- **Multi-Cloud развертывания** требуют знания различий между провайдерами и подбора подходящих инструментов

### Важные моменты

- Качество самовосстановления сильно зависит от качества приложения и его контейнеризации
- Обнаружение сбоев на уровне компонентов и инфраструктуры может занять несколько минут
- Kubernetes может перераспределить PODs, но не может создать новые узлы
- Для критически важных приложений нужна надежная инфраструктура с автоматическим восстановлением

---

Подводя итог, можно сказать, что высокодоступные и надежные приложения (ориентированные на клиентов или критически важные приложения с нулевым временем простоя) требуют самовосстановления нод и надежной подготовки инфраструктуры.

Если платформа не обеспечивает этого, производительность приложения не может быть гарантирована.

Что ж, это все в этой лекции. Увидимся в следующей.

