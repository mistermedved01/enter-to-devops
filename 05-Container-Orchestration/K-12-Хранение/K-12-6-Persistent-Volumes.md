[🏠 Главная](../../README.md) → [☸️ Container-Orchestration](../../README.md#-container-orchestration) → [💾 K-12-Хранение](../../README.md#-k-12-хранение)

---

# 💾K-12-6-Persistent-Volumes
>Persistent Volumes (PV) в Kubernetes: централизованное управление хранилищем, создание PV, accessModes, capacity, типы хранилищ

**📍 Текущая тема**

---

<details>
<summary><b>📚Введение: Проблема с Volumes в POD определениях</b></summary>

---

## Связь с предыдущей темой

В теме [K-12-5-Volumes](K-12-5-Volumes.md) мы говорили о томах, которые настраиваются непосредственно в файле определения POD.

Теперь рассмотрим Persistent Volumes в Kubernetes — более продвинутый механизм для работы с хранилищем.

---

## Проблема: децентрализованное управление хранилищем

Когда мы создавали volumes в предыдущем разделе, мы настраивали volumes в файле определения POD.

Это значит, что вся информация о конфигурации, необходимая для настройки хранилища для тома, помещается в файл определения POD.

В распределенной среде с большим количеством пользователей, для них будет развернуто множество PODs.

Пользователям каждый раз придется настраивать хранилище для каждого POD.

---

## Неудобства текущего подхода

Какое бы решение для хранения ни использовалось, пользователи, развертывающие PODs, должны будут прописывать эти настройки в каждый свой файл определений.

И при каждом внесении изменений в свою среду пользователю придется снова внести изменения в файлы определений своих приложений.

Это не кажется легким делом.

### Схема проблемы децентрализованного управления

```
┌─────────────────────────────────────────────────────────┐
│  Проблема: Volumes в POD определениях                   │
│                                                           │
│  ┌──────────────────┐        ┌──────────────────┐      │
│  │  Пользователь 1   │        │  Пользователь 2   │      │
│  │  ┌────────────┐  │        │  ┌────────────┐  │      │
│  │  │ POD 1      │  │        │  │ POD 2      │      │      │
│  │  │ volumes:   │  │        │  │ volumes:   │  │      │
│  │  │ - hostPath │  │        │  │ - nfs      │  │      │
│  │  │ - awsEBS   │  │        │  │ - ceph     │  │      │
│  │  └────────────┘  │        │  └────────────┘  │      │
│  └──────────────────┘        └──────────────────┘      │
│                                                           │
│  ❌ Каждый пользователь настраивает хранилище            │
│  ❌ Дублирование конфигурации                           │
│  ❌ Сложность управления                                │
│  ❌ Нет централизованного контроля                      │
└─────────────────────────────────────────────────────────┘
```

---

## Решение: централизованное управление

Вместо этого мы бы хотели управлять хранилищем более централизованно.

Например, чтобы оно было настроено так, чтобы администратор мог создать большой пул хранилищ, а затем нарезать на кусочки того объема, о котором попросят пользователи.

И вот в этом нам могут помочь persistent volumes или короче PV.

### Схема централизованного управления

```
┌─────────────────────────────────────────────────────────┐
│  Решение: Persistent Volumes                             │
│                                                           │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Администратор                                   │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Создает пул Persistent Volumes              │ │   │
│  │  │  - PV 1 (10Gi, AWS EBS)                     │ │   │
│  │  │  - PV 2 (20Gi, NFS)                         │ │   │
│  │  │  - PV 3 (50Gi, Azure Disk)                  │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Пользователи                                     │   │
│  │  ┌──────────────────┐  ┌──────────────────┐     │   │
│  │  │  Пользователь 1  │  │  Пользователь 2  │     │   │
│  │  │  ┌────────────┐  │  │  ┌────────────┐  │     │   │
│  │  │  │ PVC 1      │  │  │  │ PVC 2      │  │     │   │
│  │  │  │ (запрашивает│  │  │  │ (запрашивает│  │     │   │
│  │  │  │  хранилище)│  │  │  │  хранилище)│  │     │   │
│  │  │  └────────────┘  │  │  └────────────┘  │     │   │
│  │  └──────────────────┘  └──────────────────┘     │   │
│  └──────────────────────────────────────────────────┘   │
│                                                           │
│  ✅ Централизованное управление                          │
│  ✅ Пользователи просто запрашивают хранилище           │
│  ✅ Администратор контролирует доступные ресурсы       │
└─────────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>💾Что такое Persistent Volume</b></summary>

---

## Определение

Постоянный том (Persistent Volume, PV) — это пул томов хранения (storage volumes) на уровне кластера, настроенный администратором для использования пользователями, развертывающими приложения в кластере.

Теперь пользователи могут выбирать хранилище из этого пула с помощью persistent volume claims или PVC.

---

## Преимущества Persistent Volumes

### Для администратора

- Централизованное управление хранилищем
- Контроль над доступными ресурсами
- Единая точка настройки хранилища
- Упрощенное управление жизненным циклом томов

### Для пользователей

- Не нужно знать детали настройки хранилища
- Просто запрашивают нужный объем через PVC
- Не зависят от конкретного типа хранилища
- Упрощенное развертывание приложений

### Схема работы Persistent Volumes

```
┌─────────────────────────────────────────────────────────┐
│  Kubernetes Cluster                                      │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Администратор создает Persistent Volumes        │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  PV 1: 10Gi, AWS EBS, ReadWriteOnce         │ │   │
│  │  │  PV 2: 20Gi, NFS, ReadWriteMany            │ │   │
│  │  │  PV 3: 50Gi, Azure Disk, ReadWriteOnce      │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Пользователь создает Persistent Volume Claim    │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  PVC: запрос 5Gi, ReadWriteOnce             │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│                        │ Kubernetes связывает            │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  PVC связан с подходящим PV                      │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  PVC → PV 1 (10Gi, ReadWriteOnce)          │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  POD использует PVC                               │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  POD → PVC → PV → Storage Backend          │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>📝Создание Persistent Volume</b></summary>

---

## Базовый шаблон

Создадим persistent volume, начиная с базового шаблона объекта Kubernetes:

- `apiVersion`
- `kind`
- `metadata`
- `spec`

---

## Пример манифеста Persistent Volume

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-volume1
spec:
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 1Gi
  hostPath:
    path: /data
    type: DirectoryOrCreate
```

Версия API — `v1`, kind — `PersistentVolume`, в метаданных определим `name` — `pv-volume1`.

---

## Компоненты спецификации

### accessModes

В разделе спецификаций укажем режимы доступа.

Этот `accessModes` определяет, как volume должен работать на хостах.

Это похоже, как в операционной системе монтируют устройство в режим только для чтения или в режим чтения-записи.

#### Поддерживаемые значения для accessModes:

- **ReadWriteOnce (RWO)** — доступен для чтения и записи одному узлу
- **ReadOnlyMany (ROX)** — доступен только для чтения многим узлам
- **ReadWriteMany (RWX)** — доступен для чтения и записи многим узлам

> **Примечание**: В оригинальном тексте была опечатка в описании. Правильно:
> - ReadWriteOnce — чтение и запись для одного узла
> - ReadOnlyMany — только чтение для многих узлов
> - ReadWriteMany — чтение и запись для многих узлов

### capacity

Далее в разделе `capacity` указываем объем хранилища, который должен быть зарезервирован для этого persistent volume.

Здесь установлен в 1 Гибибайт.

### Тип тома

Далее идет тип тома. Здесь используется параметр `hostPath`, который использует хранилище из локального каталога этой ноды.

Помни, что эту опцию не стоит использовать в производственной среде, локальное хранилище ноды не самое надежное место.

---

</details>

<details>
<summary><b>🔧Access Modes (Режимы доступа)</b></summary>

---

## Подробнее о Access Modes

Access Modes определяют, как том может быть смонтирован на узлах кластера.

### ReadWriteOnce (RWO)

- Том может быть смонтирован как read-write на одном узле
- Несколько PODs на одном узле могут использовать этот том
- Подходит для: баз данных, stateful приложений

### ReadOnlyMany (ROX)

- Том может быть смонтирован как read-only на многих узлах одновременно
- Полезно для: конфигурационных файлов, статических данных

### ReadWriteMany (RWX)

- Том может быть смонтирован как read-write на многих узлах одновременно
- Подходит для: общих файловых систем, совместной работы приложений

### Схема Access Modes

```
┌─────────────────────────────────────────────────────────┐
│  ReadWriteOnce (RWO)                                     │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Node 1                                           │   │
│  │  ┌────────────┐  ┌────────────┐                  │   │
│  │  │ POD 1      │  │ POD 2      │                  │   │
│  │  │ (R/W)      │  │ (R/W)      │                  │   │
│  │  └─────┬──────┘  └─────┬──────┘                  │   │
│  │        └──────┬─────────┘                         │   │
│  │               ▼                                     │   │
│  │        ┌────────────┐                              │   │
│  │        │ PV (RWO)   │                              │   │
│  │        └────────────┘                              │   │
│  └──────────────────────────────────────────────────┘   │
│                                                           │
│  ReadOnlyMany (ROX)                                       │
│  ┌──────────────────┐        ┌──────────────────┐      │
│  │  Node 1          │        │  Node 2          │      │
│  │  ┌────────────┐  │        │  ┌────────────┐  │      │
│  │  │ POD 1 (RO) │  │        │  │ POD 2 (RO) │  │      │
│  │  └─────┬──────┘  │        │  └─────┬──────┘  │      │
│  └────────┼─────────┘        └────────┼─────────┘      │
│           │                           │                 │
│           └───────────┬───────────────┘                 │
│                       ▼                                 │
│           ┌──────────────────────┐                      │
│           │ PV (ROX)             │                      │
│           └──────────────────────┘                      │
│                                                           │
│  ReadWriteMany (RWX)                                      │
│  ┌──────────────────┐        ┌──────────────────┐      │
│  │  Node 1          │        │  Node 2          │      │
│  │  ┌────────────┐  │        │  ┌────────────┐  │      │
│  │  │ POD 1 (RW)│  │        │  │ POD 2 (RW) │  │      │
│  │  └─────┬──────┘  │        │  └─────┬──────┘  │      │
│  └────────┼─────────┘        └────────┼─────────┘      │
│           │                           │                 │
│           └───────────┬───────────────┘                 │
│                       ▼                                 │
│           ┌──────────────────────┐                      │
│           │ PV (RWX)             │                      │
│           └──────────────────────┘                      │
└─────────────────────────────────────────────────────────┘
```

---

## Поддержка Access Modes различными хранилищами

Не все типы хранилищ поддерживают все access modes:

| Тип хранилища | ReadWriteOnce | ReadOnlyMany | ReadWriteMany |
|--------------|---------------|--------------|---------------|
| AWS EBS | ✅ | ❌ | ❌ |
| Azure Disk | ✅ | ❌ | ❌ |
| GCP Persistent Disk | ✅ | ❌ | ❌ |
| NFS | ✅ | ✅ | ✅ |
| CephFS | ✅ | ✅ | ✅ |
| GlusterFS | ✅ | ✅ | ✅ |
| hostPath | ✅ | ❌ | ❌ |

---

</details>

<details>
<summary><b>💾Типы хранилищ для Persistent Volumes</b></summary>

---

## Замена hostPath на облачное хранилище

Теперь заменим `hostPath` одним из поддерживаемых решений хранения, как мы видели в предыдущей теме, а именно, AWS Elastic Block Store.

---

## Пример: AWS EBS Persistent Volume

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-aws-ebs
spec:
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 10Gi
  awsElasticBlockStore:
    volumeID: vol-12345678
    fsType: ext4
```

### Схема работы с AWS EBS

```
┌─────────────────────────────────────────────────────────┐
│  Kubernetes Cluster (AWS)                               │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Persistent Volume                                │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  name: pv-aws-ebs                          │ │   │
│  │  │  capacity: 10Gi                            │ │   │
│  │  │  accessModes: ReadWriteOnce                │ │   │
│  │  │  awsElasticBlockStore:                     │ │   │
│  │  │    volumeID: vol-12345678                  │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  AWS EBS Volume (vol-12345678)                  │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  10 GiB дискового пространства              │ │   │
│  │  │  ext4 файловая система                      │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Пример: NFS Persistent Volume

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs
spec:
  accessModes:
    - ReadWriteMany
  capacity:
    storage: 20Gi
  nfs:
    server: nfs-server.example.com
    path: /exports/data
```

---

## Пример: Azure Disk Persistent Volume

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-azure-disk
spec:
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 50Gi
  azureDisk:
    diskName: my-disk
    diskURI: https://mystorageaccount.blob.core.windows.net/vhds/my-disk.vhd
    cachingMode: ReadWrite
    fsType: ext4
```

---

## Пример: GCP Persistent Disk

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-gcp-disk
spec:
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 30Gi
  gcePersistentDisk:
    pdName: my-gce-disk
    fsType: ext4
```

---

</details>

<details>
<summary><b>🛠️Создание и управление Persistent Volumes</b></summary>

---

## Создание Persistent Volume

Чтобы создать persistent volume, выполним команду `kubectl create`:

```bash
kubectl create -f pv-volume1.yaml
```

Или можно использовать императивный способ:

```bash
kubectl create pv pv-volume1 \
  --access-mode=ReadWriteOnce \
  --capacity=1Gi \
  --host-path=/data
```

---

## Просмотр Persistent Volumes

Выведем список созданных томов командой `kubectl get persistentvolume`:

```bash
# Список всех PV
kubectl get pv

# Детальная информация о PV
kubectl describe pv pv-volume1

# YAML представление
kubectl get pv pv-volume1 -o yaml
```

### Пример вывода

```bash
$ kubectl get pv
NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
pv-volume1   1Gi        RWO            Retain           Available                                   5m
pv-aws-ebs   10Gi       RWO            Retain           Available                                   3m
```

---

## Состояния Persistent Volume

PV может находиться в различных состояниях:

- **Available** — том доступен для использования
- **Bound** — том связан с PVC
- **Released** — PVC удален, том освобожден
- **Failed** — том в состоянии ошибки

### Схема жизненного цикла PV

```
┌─────────────────────────────────────────────────────────┐
│  Available (доступен)                                    │
│  ┌──────────────────────────────────────────────────┐   │
│  │  PV создан и готов к использованию              │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│            PVC создан и связан                           │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Bound (связан)                                   │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  PV связан с PVC                             │ │   │
│  │  │  POD может использовать том                 │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                 │
│            PVC удален                                    │
│                        │                                 │
│                        ▼                                 │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Released (освобожден)                           │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  PVC удален, PV освобожден                  │ │   │
│  │  │  В зависимости от reclaimPolicy:            │ │   │
│  │  │  - Retain: данные сохраняются               │ │   │
│  │  │  - Delete: том удаляется                    │ │   │
│  │  │  - Recycle: том очищается (deprecated)     │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Reclaim Policy

Reclaim Policy определяет, что происходит с PV после удаления связанного PVC:

- **Retain** — том сохраняется, данные остаются (требуется ручная очистка)
- **Delete** — том автоматически удаляется вместе с данными
- **Recycle** — том очищается для повторного использования (deprecated в Kubernetes 1.14+)

---

</details>

<details>
<summary><b>⚠️Важные замечания</b></summary>

---

## hostPath в production

Помни, что опцию `hostPath` не стоит использовать в производственной среде.

Локальное хранилище ноды не самое надежное место для хранения данных.

### Проблемы hostPath

- Данные привязаны к конкретному узлу
- При удалении узла данные теряются
- Нет репликации
- Нет автоматического резервного копирования

---

## Рекомендации

Для production окружений рекомендуется использовать:

- **Облачные хранилища** (AWS EBS, Azure Disk, GCP Persistent Disk)
- **Сетевые хранилища** (NFS, CephFS, GlusterFS)
- **CSI драйверы** для интеграции с корпоративными решениями

---

</details>

---

## Резюме

### Проблема с Volumes в POD определениях

- Каждый пользователь настраивает хранилище для каждого POD
- Дублирование конфигурации
- Сложность управления изменениями
- Нет централизованного контроля

### Решение: Persistent Volumes

- Централизованное управление хранилищем администратором
- Пользователи запрашивают хранилище через PVC
- Упрощенное развертывание приложений
- Единая точка настройки хранилища

### Компоненты Persistent Volume

- **accessModes** — режимы доступа (ReadWriteOnce, ReadOnlyMany, ReadWriteMany)
- **capacity** — объем хранилища
- **Тип хранилища** — hostPath, awsElasticBlockStore, nfs и др.
- **reclaimPolicy** — политика освобождения (Retain, Delete)

### Access Modes

- **ReadWriteOnce (RWO)** — чтение и запись для одного узла
- **ReadOnlyMany (ROX)** — только чтение для многих узлов
- **ReadWriteMany (RWX)** — чтение и запись для многих узлов

### Типы хранилищ

- **hostPath** — только для разработки/тестирования
- **AWS EBS, Azure Disk, GCP Disk** — облачные хранилища
- **NFS, CephFS, GlusterFS** — сетевые хранилища

---

## Связанные темы

- **[K-12-1-Enter-Container-Storage](K-12-1-Enter-Container-Storage.md)** — введение в концепции хранения в Docker
- **[K-12-2-Storage-in-Docker](K-12-2-Storage-in-Docker.md)** — volumes в Docker
- **[K-12-3-Volume-Driver-Plugins-in-Docker](K-12-3-Volume-Driver-Plugins-in-Docker.md)** — volume driver plugins
- **[K-12-4-CSI](K-12-4-CSI.md)** — Container Storage Interface
- **[K-12-5-Volumes](K-12-5-Volumes.md)** — volumes в Kubernetes, типы volumes и их использование
- **[K-12-6-Persistent-Volumes](K-12-6-Persistent-Volumes.md)** — Persistent Volumes, централизованное управление хранилищем
- **[K-12-7-Persistent-Volume-Claims](K-12-7-Persistent-Volume-Claims.md)** — Persistent Volume Claims, запросы на хранилище

---

## Что дальше?

В следующей теме [K-12-7-Persistent-Volume-Claims](K-12-7-Persistent-Volume-Claims.md) мы рассмотрим Persistent Volume Claims (PVC) — механизм, с помощью которого пользователи запрашивают хранилище из пула Persistent Volumes, созданного администратором.

---
