[🏠 Главная](../../README.md) → [☸️ Container-Orchestration](../../README.md#-container-orchestration) → [💾 K-12-Хранение](../../README.md#-k-12-хранение)

---

# 💾K-12-4-CSI
>Container Storage Interface (CSI): стандарт для интеграции систем хранения с оркестраторами контейнеров, архитектура, RPC вызовы, поддержка различных провайдеров

---

<details>
<summary><b>📚Введение в Container Storage Interface</b></summary>

---

## Что такое CSI

Container Storage Interface (CSI) — это стандартизированный интерфейс для интеграции систем хранения с оркестраторами контейнеров.

CSI позволяет провайдерам хранилищ разрабатывать плагины, которые работают с различными системами оркестрации без необходимости модификации их исходного кода.

---

## История развития

В прошлом Kubernetes использовал Docker в качестве единственного движка среды выполнения контейнеров.

В то время весь код для работы с Docker был встроен в исходный код Kubernetes.

Со временем появилась необходимость добавить возможность работать с другими движками, такими как CRI-O и rkt.

Было важно открыть и расширить поддержку работы с различными container runtimes и не зависеть от исходного кода Kubernetes.

---

## Появление стандартов интерфейсов

Так появился Container Runtime Interface (CRI) — интерфейс среды выполнения контейнера.

Аналогично, для расширения поддержки различных сетевых решений был представлен Container Network Interface (CNI).

CSI был разработан по тому же принципу для поддержки различных решений хранения.

### Эволюция интерфейсов Kubernetes

```
┌─────────────────────────────────────────────────────────┐
│  Ранние версии Kubernetes                               │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Встроенный код для Docker                       │   │
│  │  (hardcoded в исходный код Kubernetes)           │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Появление стандартов интерфейсов                │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  CRI (Container Runtime Interface)          │ │   │
│  │  │  - Docker, CRI-O, containerd                │ │   │
│  │  ├─────────────────────────────────────────────┤ │   │
│  │  │  CNI (Container Network Interface)          │ │   │
│  │  │  - Различные сетевые решения                │ │   │
│  │  ├─────────────────────────────────────────────┤ │   │
│  │  │  CSI (Container Storage Interface)          │ │   │
│  │  │  - Различные системы хранения               │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>🔌Container Runtime Interface (CRI)</b></summary>

---

## Что такое CRI

Container Runtime Interface (CRI) — это стандарт, который определяет, как решение для оркестрации, вроде Kubernetes, будет взаимодействовать со средами выполнения контейнера, такими как Docker.

CRI позволяет Kubernetes работать с различными container runtimes без необходимости модификации исходного кода.

---

## Преимущества CRI

Таким образом, в будущем, если будет разработан какой-либо новый container runtime, он может просто следовать стандартам CRI.

И эта новая среда выполнения контейнера будет работать без необходимости разработки и добавления в себя какого-то дополнительного функционала под Kubernetes или добавления чего-то к исходному коду Kubernetes.

---

## Поддерживаемые Container Runtimes

В данный момент официально поддерживаются 3 движка:

- **Docker** — традиционный runtime (deprecated в Kubernetes 1.24+)
- **CRI-O** — легковесная альтернатива Docker
- **containerd** — с версии 1.23 дефолтный runtime

### Схема работы CRI

```
┌─────────────────────────────────────────────────────────┐
│  Kubernetes                                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  CRI Interface                                   │   │
│  │  (стандартизированный API)                       │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│        ┌───────────────┴───────────────┐                │
│        ▼                               ▼                │
│  ┌──────────────┐            ┌──────────────────┐       │
│  │  containerd  │            │  CRI-O           │       │
│  │  (default)   │            │                  │       │
│  └──────────────┘            └──────────────────┘       │
│        │                               │                │
│        └───────────────┬───────────────┘                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Container Runtime                               │   │
│  │  (управление контейнерами)                       │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>🌐Container Network Interface (CNI)</b></summary>

---

## Что такое CNI

Для расширения поддержки различных сетевых решений был представлен Container Network Interface (CNI).

Теперь любые новые поставщики сетевых услуг могут просто разработать свой плагин на основе стандартов CNI, и это их решение будет работать с Kubernetes.

---

## Принцип работы CNI

CNI определяет стандартный интерфейс для настройки сетевых интерфейсов контейнеров.

Плагины CNI могут быть разработаны независимо и интегрированы в Kubernetes без изменения его исходного кода.

### Популярные CNI плагины

- **Calico** — сетевые политики и маршрутизация
- **Flannel** — простая overlay сеть
- **Weave** — автоматическая маршрутизация
- **Cilium** — eBPF-based networking

---

</details>

<details>
<summary><b>💾Container Storage Interface (CSI)</b></summary>

---

## Назначение CSI

Интерфейс контейнерного хранилища (CSI) был разработан для поддержки нескольких решений хранения.

С CSI теперь мы можем написать свои собственные драйверы для собственного хранилища для работы с Kubernetes.

---

## Универсальность CSI

Обрати внимание, что CSI не является специфическим стандартом Kubernetes.

Это универсальный стандарт, и он позволяет любому инструменту оркестрации контейнеров работать с любым поставщиком хранилища с поддерживаемым плагином.

---

## Поддерживаемые оркестраторы

В настоящее время полностью приняли CSI 4 оркестратора:

- **Kubernetes** — основной оркестратор
- **Cloud Foundry** — платформа для облачных приложений
- **Nomad** — оркестратор от HashiCorp
- **Mesos** — распределенная система управления ресурсами

### Схема универсальности CSI

```
┌─────────────────────────────────────────────────────────┐
│  Оркестраторы контейнеров                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────┐  │
│  │Kubernetes│  │Cloud     │  │  Nomad   │  │ Mesos   │  │
│  │          │  │Foundry   │  │          │  │         │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬────┘  │
│       │             │             │             │       │
│       └─────────────┴─────────────┴─────────────┘       │
│                        │                                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  CSI Interface (универсальный стандарт)          │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  CSI Drivers (провайдеры хранилищ)               │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐        │   │
│  │  │AWS EBS   │  │Azure Disk│  │Ceph      │        │   │
│  │  │GlusterFS │  │Portworx  │  │NetApp    │        │   │
│  │  └──────────┘  └──────────┘  └──────────┘        │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>🏗️Архитектура CSI</b></summary>

---

## Как работает CSI

CSI определяет набор RPC (Remote Procedure Calls) или удаленных вызовов процедур, которые будут инициироваться оркестратором контейнеров, и они должны быть реализованы в storage drivers.

### Схема взаимодействия

```
┌─────────────────────────────────────────────────────────┐
│  Kubernetes (Orchestrator)                              │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Инициирует RPC вызовы через CSI                 │   │
│  │  - CreateVolume                                  │   │
│  │  - DeleteVolume                                  │   │
│  │  - AttachVolume                                  │   │
│  │  - DetachVolume                                  │   │
│  │  - MountVolume                                   │   │
│  │  - UnmountVolume                                 │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│                        │ gRPC                           │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  CSI Driver (Storage Provider Plugin)            │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  Реализует RPC методы                       │ │   │
│  │  │  - CreateVolume()                           │ │   │
│  │  │  - DeleteVolume()                           │ │   │
│  │  │  - AttachVolume()                           │ │   │
│  │  │  - DetachVolume()                           │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Storage Backend                                 │   │
│  │  (AWS EBS, Azure Disk, Ceph, etc.)               │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## Пример: CreateVolume

Например, CSI говорит, что когда создается POD, и ему требуется volume, то оркестратор контейнеров в данном случае, Kubernetes, должен вызвать RPC `CreateVolume` и передать в него набор деталей, таких как имя этого volume.

Storage driver должен реализовывать этот удаленный вызов и обработать запрос, предоставив новый том в области хранения и вернув результат операции.

### Последовательность создания тома

```
┌─────────────────────────────────────────────────────────┐
│  1. Kubernetes обнаруживает потребность в томе          │
│     (PVC создан, требуется PV)                          │
│                        │                                │
│                        ▼                                │
│  2. Kubernetes вызывает CSI RPC: CreateVolume           │
│     ┌─────────────────────────────────────────────┐     │
│     │  Параметры:                                 │     │
│     │  - name: "my-volume"                        │     │
│     │  - size: "10Gi"                             │     │
│     │  - storageClass: "fast-ssd"                 │     │
│     └─────────────────────────────────────────────┘     │
│                        │                                │
│                        ▼                                │
│  3. CSI Driver обрабатывает запрос                      │
│     ┌─────────────────────────────────────────────┐     │
│     │  - Создает том в storage backend            │     │
│     │  - Возвращает volume ID                     │     │
│     └─────────────────────────────────────────────┘     │
│                        │                                │
│                        ▼                                │
│  4. Kubernetes получает результат                       │
│     ┌─────────────────────────────────────────────┐     │
│     │  Volume ID: "vol-12345678"                  │     │
│     │  Status: SUCCESS                            │     │
│     └─────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────┘
```

---

## Пример: DeleteVolume

Точно так же оркестратор контейнеров должен осуществить вызов RPC `DeleteVolume`, когда volume должен быть удален, а драйвер хранилища должен содержать в себе реализацию действия вывода тома из массива хранения при выполнении этого вызова.

---

## Стандартизация параметров

В спецификации CSI точно указано, какие параметры должны быть отправлены оркестратором, что именно может получать драйвер и какие коды ошибок они должны предоставлять.

Это обеспечивает совместимость между различными оркестраторами и провайдерами хранилищ.

---

</details>

<details>
<summary><b>📋Основные RPC методы CSI</b></summary>

---

## Категории RPC методов

CSI определяет несколько категорий RPC методов для различных операций с хранилищем:

### Identity Service

Методы для идентификации и получения информации о драйвере:

- `GetPluginInfo` — информация о плагине
- `GetPluginCapabilities` — возможности плагина
- `Probe` — проверка доступности плагина

### Controller Service

Методы для управления томами на уровне контроллера:

- `CreateVolume` — создание тома
- `DeleteVolume` — удаление тома
- `ControllerPublishVolume` — подключение тома к узлу
- `ControllerUnpublishVolume` — отключение тома от узла
- `ValidateVolumeCapabilities` — проверка возможностей тома
- `ListVolumes` — список томов
- `GetCapacity` — получение доступной емкости

### Node Service

Методы для работы с томами на уровне узла:

- `NodeStageVolume` — подготовка тома к монтированию
- `NodeUnstageVolume` — отмена подготовки тома
- `NodePublishVolume` — монтирование тома в POD
- `NodeUnpublishVolume` — размонтирование тома из POD
- `NodeGetVolumeStats` — статистика использования тома
- `NodeGetCapabilities` — возможности узла

### Схема жизненного цикла тома

```
┌─────────────────────────────────────────────────────────┐
│  Создание тома                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │  1. CreateVolume (Controller Service)            │   │
│  │     → Том создан в storage backend               │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Подключение к узлу                              │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  2. ControllerPublishVolume                 │ │   │
│  │  │     → Том подключен к узлу                  │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Подготовка на узле                              │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  3. NodeStageVolume                         │ │   │
│  │  │     → Том подготовлен к монтированию        │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Монтирование в POD                              │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  4. NodePublishVolume                       │ │   │
│  │  │     → Том смонтирован в POD                 │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Удаление (обратный порядок)                     │   │
│  │  ┌─────────────────────────────────────────────┐ │   │
│  │  │  5. NodeUnpublishVolume                     │ │   │
│  │  │  6. NodeUnstageVolume                       │ │   │
│  │  │  7. ControllerUnpublishVolume               │ │   │
│  │  │  8. DeleteVolume                            │ │   │
│  │  └─────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>🔌Провайдеры хранилищ с CSI драйверами</b></summary>

---

## Популярные CSI драйверы

Множество провайдеров хранилищ разработали свои CSI драйверы:

### Облачные провайдеры

- **AWS EBS** — Elastic Block Store от Amazon
- **Azure Disk** — управляемые диски Azure
- **Google Persistent Disk** — постоянные диски GCP
- **DigitalOcean Block Storage** — блочное хранилище DigitalOcean

### Сетевые хранилища

- **Ceph** — распределенное хранилище
- **GlusterFS** — распределенная файловая система
- **NFS** — Network File System

### Корпоративные решения

- **Dell EMC** — различные продукты (Isilon, ScaleIO, Unity)
- **NetApp** — Trident CSI driver
- **Portworx** — контейнерное хранилище
- **Hitachi** — Hitachi Storage Plug-in for Containers
- **HP** — HP Enterprise Storage

### Схема экосистемы CSI

```
┌─────────────────────────────────────────────────────────┐
│  Kubernetes                                             │
│  ┌──────────────────────────────────────────────────┐   │
│  │  CSI Interface                                   │   │
│  └──────────────────────────────────────────────────┘   │
│                        │                                │
│        ┌───────────────┴───────────────┐                │
│        │                               │                │
│        ▼                               ▼                │
│  ┌──────────────┐            ┌──────────────────┐       │
│  │ Облачные     │            │ Корпоративные    │       │
│  │ провайдеры   │            │ решения          │       │
│  │              │            │                  │       │
│  │ - AWS EBS    │            │ - Dell EMC       │       │
│  │ - Azure Disk │            │ - NetApp         │       │
│  │ - GCP Disk   │            │ - Portworx       │       │
│  └──────────────┘            │ - Hitachi        │       │
│                              └──────────────────┘       │
│        │                               │                │
│        └───────────────┬───────────────┘                │
│                        ▼                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │  Сетевые хранилища                               │   │
│  │  - Ceph                                          │   │
│  │  - GlusterFS                                     │   │
│  │  - NFS                                           │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

</details>

<details>
<summary><b>📖Спецификация CSI</b></summary>

---

## Где найти спецификацию

Если тебе интересно, ты можешь просмотреть все эти детали в спецификации CSI на GitHub.

Официальная спецификация CSI доступна в репозитории: [container-storage-interface/spec](https://github.com/container-storage-interface/spec)

---

## Что содержит спецификация

Спецификация CSI включает:

- **Определение всех RPC методов** — полный список методов с описанием
- **Параметры запросов и ответов** — структуры данных для каждого метода
- **Коды ошибок** — стандартизированные коды ошибок
- **Примеры использования** — примеры реализации драйверов
- **Версионирование** — информация о версиях спецификации

---

## Версии CSI

CSI развивается, и спецификация имеет версии:

- **CSI v1.0** — первая стабильная версия
- **CSI v1.1** — улучшения и новые возможности
- **CSI v1.2+** — дальнейшие улучшения

При разработке драйвера важно следовать актуальной версии спецификации.

---

</details>

---

## Резюме

### Что такое CSI

- **Container Storage Interface** — универсальный стандарт для интеграции хранилищ
- Не специфичен для Kubernetes — работает с различными оркестраторами
- Позволяет провайдерам разрабатывать драйверы без изменения кода оркестратора

### История развития

- Появление CRI для поддержки различных container runtimes
- Появление CNI для поддержки различных сетевых решений
- Появление CSI для поддержки различных систем хранения

### Архитектура CSI

- Определяет набор RPC методов для работы с хранилищем
- Оркестратор инициирует RPC вызовы
- Storage driver реализует эти методы
- Стандартизированные параметры и коды ошибок

### Основные RPC методы

- **Identity Service** — идентификация плагина
- **Controller Service** — управление томами (CreateVolume, DeleteVolume и др.)
- **Node Service** — работа с томами на узле (NodeStageVolume, NodePublishVolume и др.)

### Провайдеры хранилищ

- Облачные провайдеры: AWS EBS, Azure Disk, GCP Disk
- Корпоративные решения: Dell EMC, NetApp, Portworx, Hitachi
- Сетевые хранилища: Ceph, GlusterFS, NFS

---

## Связанные темы

- **[K-12-1-Enter-Container-Storage](K-12-1-Enter-Container-Storage.md)** — введение в концепции хранения в Docker
- **[K-12-2-Storage-in-Docker](K-12-2-Storage-in-Docker.md)** — volumes в Docker
- **[K-12-3-Volume-Driver-Plugins-in-Docker](K-12-3-Volume-Driver-Plugins-in-Docker.md)** — volume driver plugins
- **[K-12-4-CSI](K-12-4-CSI.md)** — Container Storage Interface **← Текущая тема**
- **[K-12-5-Volumes](K-12-5-Volumes.md)** — volumes в Kubernetes, типы volumes и их использование
- **[K-12-6-Persistent-Volumes](K-12-6-Persistent-Volumes.md)** — Persistent Volumes, централизованное управление хранилищем
- **[K-12-7-Persistent-Volume-Claims](K-12-7-Persistent-Volume-Claims.md)** — Persistent Volume Claims, запросы на хранилище

---

## Что дальше?

В следующей теме [K-12-5-Volumes](K-12-5-Volumes.md) мы рассмотрим, как volumes используются в Kubernetes, изучим различные типы volumes и их применение в POD определениях.

---

## Полезные ссылки

- [CSI Specification](https://github.com/container-storage-interface/spec) — официальная спецификация CSI
- [CSI Drivers](https://kubernetes-csi.github.io/docs/drivers.html) — список доступных CSI драйверов для Kubernetes